# Alternativa para deploy sem rsync - use apenas se necessÃ¡rio
# Substitua o step "ðŸ“¤ Enviar cÃ³digo atualizado" por este:

    - name: ðŸ“¤ Enviar cÃ³digo atualizado (alternativa sem rsync)
      run: |
        echo "ðŸ“¤ Enviando arquivos..."
        
        # Criar arquivo temporÃ¡rio compactado excluindo arquivos desnecessÃ¡rios
        echo "ðŸ“¦ Preparando arquivos para envio..."
        
        # Criar diretÃ³rio temporÃ¡rio para arquivos limpos
        TEMP_DIR=$(mktemp -d)
        echo "ðŸ“ Criando pacote limpo em: $TEMP_DIR"
        
        # Copiar arquivos necessÃ¡rios para o diretÃ³rio temporÃ¡rio
        # Usar cp com find para sistemas sem rsync
        find . -type f \
            ! -path './.git/*' \
            ! -path './.github/*' \
            ! -path './__pycache__/*' \
            ! -path './venv*/*' \
            ! -path './uploads/*' \
            ! -path './logs/*' \
            ! -path './backups/*' \
            ! -path './.pytest_cache/*' \
            ! -path './node_modules/*' \
            ! -name '*.pyc' \
            ! -name '.env' \
            ! -name 'users.json' \
            ! -name '*.log' \
            ! -name 'session_*.json' \
            ! -name 'deploy_package.tar.gz' \
            -exec cp --parents {} $TEMP_DIR/ \;
        
        # Criar arquivo compactado do diretÃ³rio limpo
        echo "ðŸ—œï¸ Compactando arquivos..."
        tar -czf deploy_package.tar.gz -C $TEMP_DIR .
        
        # Limpar diretÃ³rio temporÃ¡rio
        rm -rf $TEMP_DIR
        echo "âœ… Pacote criado: $(ls -lh deploy_package.tar.gz | awk '{print $5}')"
        
        # Verificar se o pacote foi criado com sucesso
        if [ ! -f deploy_package.tar.gz ]; then
            echo "âŒ Erro: Pacote nÃ£o foi criado!"
            exit 1
        fi
        
        # Enviar arquivo compactado
        echo "ðŸš€ Enviando pacote..."
        scp -i ~/.ssh/gcp_deploy -o StrictHostKeyChecking=no \
            deploy_package.tar.gz \
            ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }}:/tmp/
            
        echo "âœ… Pacote enviado com sucesso"
        
        # Extrair no servidor
        echo "ðŸ“‚ Extraindo arquivos na VM..."
        ssh -i ~/.ssh/gcp_deploy ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} "
          # Usar variÃ¡vel de ambiente para o usuÃ¡rio correto
          USER_HOME=/home/\$USER
          PROJECT_DIR=\$USER_HOME/analise-cartao
          
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p \$PROJECT_DIR
          cd \$PROJECT_DIR
          
          echo 'ðŸ“ Trabalhando no diretÃ³rio:' \$(pwd)
          
          # Fazer backup dos arquivos importantes antes de extrair
          mkdir -p temp_backup
          [ -f .env ] && cp .env temp_backup/
          [ -f users.json ] && cp users.json temp_backup/
          [ -d uploads ] && cp -r uploads temp_backup/ 2>/dev/null || true
          
          # Limpar diretÃ³rio atual (exceto backups e arquivos importantes)
          find . -maxdepth 1 -type f ! -name '.env' ! -name 'users.json' -delete 2>/dev/null || true
          find . -maxdepth 1 -type d ! -name '.' ! -name 'uploads' ! -name 'logs' ! -name 'backups' ! -name 'ssl' ! -name 'temp_backup' -exec rm -rf {} + 2>/dev/null || true
          
          # Extrair novos arquivos
          tar -xzf /tmp/deploy_package.tar.gz
          
          # Restaurar arquivos importantes
          [ -f temp_backup/.env ] && cp temp_backup/.env .
          [ -f temp_backup/users.json ] && cp temp_backup/users.json .
          [ -d temp_backup/uploads ] && cp -r temp_backup/uploads . 2>/dev/null || true
          
          # Limpar
          rm -rf temp_backup /tmp/deploy_package.tar.gz
          
          echo 'âœ… Arquivos extraÃ­dos e configurados'
        "
        
        # Remover arquivo temporÃ¡rio local
        rm -f deploy_package.tar.gz
        
        echo "âœ… Arquivos enviados"