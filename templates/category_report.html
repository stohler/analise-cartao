{% extends "base.html" %}

{% block title %}Relatório por Categoria - Analisador de PDFs{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Relatório por Categoria
                </h5>
            </div>
            <div class="card-body">
                <!-- Filtros -->
                <div class="row mb-4">
                    <div class="col-12">
                        <form method="GET" action="{{ url_for('category_report') }}" class="row g-3">
                            <div class="col-md-3">
                                <label for="start_date" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                       value="{{ current_filters.start_date }}" required>
                            </div>
                            <div class="col-md-3">
                                <label for="end_date" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" 
                                       value="{{ current_filters.end_date }}" required>
                            </div>
                            <div class="col-md-3">
                                <label for="category" class="form-label">Categoria</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">Todas as categorias</option>
                                    {% for cat in available_categories %}
                                    <option value="{{ cat.nome }}" 
                                            {% if current_filters.category == cat.nome %}selected{% endif %}>
                                        {{ cat.nome_exibicao }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="card_origin" class="form-label">Origem do Cartão</label>
                                <select class="form-select" id="card_origin" name="card_origin">
                                    <option value="">Todas as origens</option>
                                    {% for origin in card_origins %}
                                    <option value="{{ origin }}" 
                                            {% if current_filters.card_origin == origin %}selected{% endif %}>
                                        {{ origin }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Filtrar
                                </button>
                                <a href="{{ url_for('category_report') }}" class="btn btn-secondary ms-2">
                                    <i class="fas fa-refresh me-1"></i>Limpar Filtros
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                {% if report.success %}
                <!-- Resumo -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">R$ {{ "%.2f"|format(report.total_amount) }}</h4>
                            <small class="text-muted">Valor Total</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ report.total_transactions }}</h4>
                            <small class="text-muted">Total Transações</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">{{ report.categories|length }}</h4>
                            <small class="text-muted">Categorias</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">
                                {{ report.period.start_date }} a {{ report.period.end_date }}
                            </h4>
                            <small class="text-muted">Período</small>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Pizza (placeholder) -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Distribuição por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for category_name, category_data in report.categories.items() %}
                                    <div class="col-md-3 col-sm-6 mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                                     style="width: 40px; height: 40px;">
                                                    <span class="text-white fw-bold">{{ "%.0f"|format((category_data.total_amount / report.total_amount) * 100) }}%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ category_data.name|title }}</div>
                                                <div class="text-muted small">
                                                    R$ {{ "%.2f"|format(category_data.total_amount) }} 
                                                    ({{ category_data.count }} trans.)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela Detalhada -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Detalhamento por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Categoria</th>
                                                <th>Valor Total</th>
                                                <th>Transações</th>
                                                <th>Valor Médio</th>
                                                <th>% do Total</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for category_name, category_data in report.categories.items() %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-primary">{{ category_data.name|title }}</span>
                                                </td>
                                                <td class="fw-bold">R$ {{ "%.2f"|format(category_data.total_amount) }}</td>
                                                <td>{{ category_data.count }}</td>
                                                <td>R$ {{ "%.2f"|format(category_data.total_amount / category_data.count) }}</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar" role="progressbar" 
                                                             style="width: {{ (category_data.total_amount / report.total_amount) * 100 }}%"
                                                             aria-valuenow="{{ (category_data.total_amount / report.total_amount) * 100 }}" 
                                                             aria-valuemin="0" aria-valuemax="100">
                                                            {{ "%.1f"|format((category_data.total_amount / report.total_amount) * 100) }}%
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            onclick="toggleCategoryDetails('{{ category_name }}')">
                                                        <i class="fas fa-eye"></i> Ver Detalhes
                                                    </button>
                                                </td>
                                            </tr>
                                            <!-- Detalhes das transações (inicialmente ocultos) -->
                                            <tr id="details-{{ category_name }}" style="display: none;">
                                                <td colspan="6">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="mb-0">Transações da categoria: {{ category_name|title }}</h6>
                                                            <small class="text-muted">Ordenadas por valor (maior para menor)</small>
                                                            <div class="mt-2">
                                                                <span class="badge bg-warning text-dark me-2">
                                                                    <i class="fas fa-info-circle me-1"></i>Linhas amarelas: 80% do valor total
                                                                </span>
                                                                <span class="badge bg-primary me-2">
                                                                    <i class="fas fa-calculator me-1"></i>Saldo: soma acumulada
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="table-responsive">
                                                                <table class="table table-sm">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Data</th>
                                                                            <th>Descrição</th>
                                                                            <th>Valor <i class="fas fa-sort-amount-down text-primary"></i></th>
                                                                            <th>Saldo Acumulado</th>
                                                                            <th>Origem</th>
                                                                            <th>Banco</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% set sorted_transactions = category_data.transactions|sort(attribute='valor', reverse=true) %}
                                                                        {% set total_category_value = category_data.total_amount %}
                                                                        {% set threshold_80_percent = total_category_value * 0.8 %}
                                                                        
                                                                        {% for transaction in sorted_transactions %}
                                                                        {% set current_sum = sorted_transactions[:loop.index]|sum(attribute='valor') %}
                                                                        {% set is_above_80_percent = current_sum <= threshold_80_percent %}
                                                                        <tr class="{% if is_above_80_percent %}table-warning{% endif %}">
                                                                            <td>
                                                                                {% if transaction.data %}
                                                                                    {% set date_str = transaction.data.split('T')[0] %}
                                                                                    {% set date_parts = date_str.split('-') %}
                                                                                    {% if date_parts|length == 3 %}
                                                                                        {{ date_parts[2] }}/{{ date_parts[1] }}/{{ date_parts[0] }}
                                                                                    {% else %}
                                                                                        {{ transaction.data }}
                                                                                    {% endif %}
                                                                                {% else %}
                                                                                    N/A
                                                                                {% endif %}
                                                                            </td>
                                                                            <td>{{ transaction.descricao }}</td>
                                                                            <td class="fw-bold">R$ {{ "%.2f"|format(transaction.valor) }}</td>
                                                                            <td class="fw-bold text-primary">R$ {{ "%.2f"|format(current_sum) }}</td>
                                                                            <td>{{ transaction.origem_cartao }}</td>
                                                                            <td>{{ transaction.banco }}</td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                    <tfoot>
                                                                        <tr class="table-info">
                                                                            <td colspan="3" class="text-end fw-bold">
                                                                                <i class="fas fa-calculator me-1"></i>Total da Categoria:
                                                                            </td>
                                                                            <td class="fw-bold">R$ {{ "%.2f"|format(total_category_value) }}</td>
                                                                            <td colspan="2"></td>
                                                                        </tr>
                                                                        <tr class="table-warning">
                                                                            <td colspan="3" class="text-end fw-bold">
                                                                                <i class="fas fa-chart-line me-1"></i>80% do Total:
                                                                            </td>
                                                                            <td class="fw-bold">R$ {{ "%.2f"|format(threshold_80_percent) }}</td>
                                                                            <td colspan="2"></td>
                                                                        </tr>
                                                                    </tfoot>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% else %}
                <!-- Mensagem de erro -->
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {{ report.message }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function toggleCategoryDetails(categoryName) {
    const detailsRow = document.getElementById('details-' + categoryName);
    const button = event.target.closest('button');
    
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        button.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Detalhes';
    } else {
        detailsRow.style.display = 'none';
        button.innerHTML = '<i class="fas fa-eye"></i> Ver Detalhes';
    }
}
</script>
{% endblock %}
