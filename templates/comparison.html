{% extends "base.html" %}

{% block title %}Comparativo Mensal - Analisador de PDFs{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Comparativo dos Últimos 6 Meses
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">R$ {{ "%.2f"|format(report.summary.total_value_6_months) }}</h4>
                            <small class="text-muted">Valor Total</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">R$ {{ "%.2f"|format(report.summary.average_monthly_value) }}</h4>
                            <small class="text-muted">Média Mensal</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">{{ report.summary.total_transactions_6_months }}</h4>
                            <small class="text-muted">Total Transações</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ "%.1f"|format(report.summary.installment_percentage) }}%</h4>
                            <small class="text-muted">Parceladas</small>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Categorias por Mês -->
                {% if categories_data.success %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>Gastos por Categoria (Últimos 6 Meses)
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Controles do Gráfico -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="select-all-categories" checked>
                                            <label class="form-check-label" for="select-all-categories">
                                                <strong>Selecionar Todas</strong>
                                            </label>
                                        </div>
                                        {% for category in categories_data.categories %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input category-checkbox" type="checkbox" 
                                                   id="category-{{ category }}" value="{{ category }}" checked>
                                            <label class="form-check-label" for="category-{{ category }}">
                                                {{ category|title }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="toggleChartType()">
                                            <i class="fas fa-chart-line" id="chart-type-icon"></i>
                                            <span id="chart-type-text">Linha</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Canvas do Gráfico -->
                                <div class="chart-container" style="position: relative; height: 400px;">
                                    <canvas id="categoriesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <h6>Dados Mensais:</h6>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Mês</th>
                                <th>Valor Total</th>
                                <th>Transações</th>
                                <th>Parceladas</th>
                                <th>Média por Transação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month, stats in report.monthly_data.items() %}
                            {% if stats.total_transactions > 0 %}
                            <tr>
                                <td><strong>{{ month }}</strong></td>
                                <td>R$ {{ "%.2f"|format(stats.total_value) }}</td>
                                <td>{{ stats.total_transactions }}</td>
                                <td>{{ stats.installments }}</td>
                                <td>R$ {{ "%.2f"|format(stats.average_transaction) }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <h6 class="mt-4">Insights:</h6>
                <div class="alert alert-info">
                    {% for insight in report.insights %}
                    <div class="mb-1">{{ insight }}</div>
                    {% endfor %}
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6>Por Categoria (6 meses):</h6>
                        <div class="list-group">
                            {% if report.summary.by_category %}
                                {% for category, value in report.summary.by_category.items() %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ category|title }}
                                    <span class="badge bg-primary rounded-pill">R$ {{ "%.2f"|format(value) }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="list-group-item text-muted">
                                    Nenhuma categoria encontrada
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Por Banco (6 meses):</h6>
                        <div class="list-group">
                            {% if report.summary.by_bank %}
                                {% for bank, count in report.summary.by_bank.items() %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ bank|title }}
                                    <span class="badge bg-secondary rounded-pill">{{ count }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="list-group-item text-muted">
                                    Nenhum banco encontrado
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if categories_data.success %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Dados do gráfico
const categoriesData = {{ categories_data.data|tojson }};
const monthsLabels = {{ categories_data.months_labels|tojson }};
const categories = {{ categories_data.categories|tojson }};

// Cores para as categorias
const categoryColors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384',
    '#36A2EB', '#FFCE56', '#9966FF', '#FF9F40', '#C9CBCF'
];

let chart;
let chartType = 'line';

// Inicializar gráfico
function initChart() {
    const ctx = document.getElementById('categoriesChart').getContext('2d');
    
    const datasets = categories.map((category, index) => ({
        label: category.charAt(0).toUpperCase() + category.slice(1),
        data: categoriesData[category] || [],
        borderColor: categoryColors[index % categoryColors.length],
        backgroundColor: categoryColors[index % categoryColors.length] + '20',
        fill: false,
        tension: 0.1,
        hidden: false
    }));

    chart = new Chart(ctx, {
        type: chartType,
        data: {
            labels: monthsLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Gastos por Categoria por Mês'
                },
                legend: {
                    display: false // Vamos usar checkboxes personalizados
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// Alternar tipo de gráfico
function toggleChartType() {
    chartType = chartType === 'line' ? 'bar' : 'line';
    const icon = document.getElementById('chart-type-icon');
    const text = document.getElementById('chart-type-text');
    
    if (chartType === 'line') {
        icon.className = 'fas fa-chart-line';
        text.textContent = 'Linha';
    } else {
        icon.className = 'fas fa-chart-bar';
        text.textContent = 'Barras';
    }
    
    chart.destroy();
    initChart();
}

// Controle de checkboxes
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    
    // Selecionar/Deselecionar todas as categorias
    document.getElementById('select-all-categories').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.category-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            updateChart();
        });
    });
    
    // Controle individual de categorias
    document.querySelectorAll('.category-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateChart();
            updateSelectAllCheckbox();
        });
    });
});

// Atualizar gráfico baseado nas categorias selecionadas
function updateChart() {
    const selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked'))
        .map(checkbox => checkbox.value);
    
    chart.data.datasets.forEach((dataset, index) => {
        const category = categories[index];
        dataset.hidden = !selectedCategories.includes(category);
    });
    
    chart.update();
}

// Atualizar checkbox "Selecionar Todas"
function updateSelectAllCheckbox() {
    const allCheckboxes = document.querySelectorAll('.category-checkbox');
    const checkedCheckboxes = document.querySelectorAll('.category-checkbox:checked');
    const selectAllCheckbox = document.getElementById('select-all-categories');
    
    selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
    selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
}
</script>
{% endif %}

<!-- Tabela de Parcelamentos Futuros -->
{% if installments_data.success %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Parcelamentos Futuros (Próximos 6 Meses)
                </h6>
                <small class="text-muted">
                    Baseado na data de pagamento das transações parceladas
                </small>
            </div>
            <div class="card-body">
                {% if installments_data.total_installments > 0 %}
                <!-- Resumo -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h5 class="text-primary">{{ installments_data.total_installments }}</h5>
                            <small class="text-muted">Total de Parcelas</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h5 class="text-success">R$ {{ "%.2f"|format(installments_data.total_value) }}</h5>
                            <small class="text-muted">Valor Total</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h5 class="text-info">R$ {{ "%.2f"|format(installments_data.total_value / 6) }}</h5>
                            <small class="text-muted">Média Mensal</small>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Parcelamentos -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Item</th>
                                {% for month in installments_data.months %}
                                <th class="text-center">{{ month.name.split()[0][:3] }}/{{ month.year }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Agrupar itens únicos -->
                            {% set unique_items = {} %}
                            {% for month_key, installments in installments_data.data.items() %}
                                {% for installment in installments %}
                                    {% set item_key = installment.description %}
                                    {% if item_key not in unique_items %}
                                        {% set _ = unique_items.update({item_key: {}}) %}
                                    {% endif %}
                                    {% set _ = unique_items[item_key].update({month_key: installment}) %}
                                {% endfor %}
                            {% endfor %}

                            {% for item_description, months_data in unique_items.items() %}
                            <tr>
                                <td>
                                    <strong>{{ item_description[:50] }}{% if item_description|length > 50 %}...{% endif %}</strong>
                                    {% set first_installment = months_data.values()|list|first %}
                                    {% if first_installment %}
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-credit-card me-1"></i>{{ first_installment.origem_cartao }}
                                        <i class="fas fa-university ms-2 me-1"></i>{{ first_installment.banco|title }}
                                        <i class="fas fa-tag ms-2 me-1"></i>{{ first_installment.categoria|title }}
                                    </small>
                                    {% endif %}
                                </td>
                                {% for month in installments_data.months %}
                                <td class="text-center">
                                    {% if month.key in months_data %}
                                    {% set installment = months_data[month.key] %}
                                    <span class="badge bg-primary">
                                        {{ installment.installment_number }}/{{ installment.total_installments }}
                                    </span>
                                    <br>
                                    <strong class="text-success">R$ {{ "%.2f"|format(installment.value) }}</strong>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-info">
                            <tr>
                                <th>Total por Mês</th>
                                {% for month in installments_data.months %}
                                <th class="text-center">
                                    {% if month.key in installments_data.total_by_month %}
                                    <strong class="text-primary">R$ {{ "%.2f"|format(installments_data.total_by_month[month.key]) }}</strong>
                                    {% else %}
                                    <span class="text-muted">R$ 0,00</span>
                                    {% endif %}
                                </th>
                                {% endfor %}
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum parcelamento futuro encontrado</h5>
                    <p class="text-muted">Não há parcelas pendentes para os próximos 6 meses.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}