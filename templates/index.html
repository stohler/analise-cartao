{% extends "base.html" %}

{% block title %}Início - Analisador de PDFs{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>Upload e Análise de PDF
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Arraste e solte seu PDF aqui</h5>
                        <p class="text-muted">ou clique para selecionar um arquivo</p>
                        <input type="file" name="file" id="fileInput" accept=".pdf" class="d-none">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Selecionar Arquivo
                        </button>
                    </div>
                    <div class="mt-3" id="fileInfo" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-file-pdf me-2"></i>
                            <span id="fileName"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Campo de data de pagamento -->
                    <div class="mt-3" id="paymentDateSection" style="display: none;">
                        <label for="paymentDate" class="form-label">
                            <i class="fas fa-calendar me-2"></i>Data de Pagamento
                        </label>
                        <input type="date" class="form-control" id="paymentDate" name="payment_date" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Data em que o pagamento foi efetuado (usado para filtros e relatórios)
                        </div>
                    </div>
                    
                    <div class="d-grid mt-3">
                        <button type="submit" class="btn btn-primary" id="analyzeBtn" disabled>
                            <i class="fas fa-search me-2"></i>Analisar PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Bancos Suportados
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Nubank</li>
                            <li><i class="fas fa-check text-success me-2"></i>Itaú</li>
                            <li><i class="fas fa-check text-success me-2"></i>Bradesco</li>
                            <li><i class="fas fa-check text-success me-2"></i>Santander</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>BTG Pactual</li>
                            <li><i class="fas fa-check text-success me-2"></i>Unicred</li>
                            <li><i class="fas fa-check text-success me-2"></i>C6 Bank</li>
                            <li><i class="fas fa-check text-success me-2"></i>Caixa</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Estatísticas
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ stats.total }}</h4>
                        <small class="text-muted">Transações Locais</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ mongo_count }}</h4>
                        <small class="text-muted">MongoDB</small>
                    </div>
                </div>
                <hr>
                <div class="mb-2">
                    <strong>Valor Total:</strong>
                    <span class="float-end">R$ {{ "%.2f"|format(stats.valor_total) }}</span>
                </div>
                <div class="mb-2">
                    <strong>Parceladas:</strong>
                    <span class="float-end">{{ stats.parceladas }}</span>
                </div>
                <div class="mb-2">
                    <strong>Média por Transação:</strong>
                    <span class="float-end">R$ {{ "%.2f"|format(stats.valor_total / stats.total if stats.total > 0 else 0) }}</span>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>Status MongoDB
                </h5>
            </div>
            <div class="card-body text-center">
                {% if mongo_connected %}
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h6 class="text-success">Conectado</h6>
                    <p class="text-muted small">Pronto para salvar transações</p>
                {% else %}
                    <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                    <h6 class="text-danger">Desconectado</h6>
                    <p class="text-muted small">Apenas armazenamento local</p>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-download me-2"></i>Exportar Dados
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="exportToMongoDB()">
                        <i class="fas fa-database me-2"></i>Exportar para MongoDB
                    </button>
                    <a href="{{ url_for('view_transactions') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-2"></i>Ver Transações
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const analyzeBtn = document.getElementById('analyzeBtn');

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#0d6efd';
        uploadArea.style.backgroundColor = '#f8f9fa';
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#dee2e6';
        uploadArea.style.backgroundColor = 'transparent';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#dee2e6';
        uploadArea.style.backgroundColor = 'transparent';
        
        const files = e.dataTransfer.files;
        console.log('Drop event, files:', files.length);
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        console.log('File input changed, files:', e.target.files.length);
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    function handleFile(file) {
        console.log('File selected:', file.name, file.type);
        if (file.type === 'application/pdf') {
            // Store the file for form submission
            window.selectedFile = file;
            console.log('File stored for submission');
            
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            
            // Mostrar campo de data de pagamento
            document.getElementById('paymentDateSection').style.display = 'block';
            
            // Definir data padrão como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            
            analyzeBtn.disabled = false;
            console.log('PDF file accepted, button enabled. Button disabled:', analyzeBtn.disabled);
        } else {
            console.log('Invalid file type:', file.type);
            showToast('Apenas arquivos PDF são permitidos', 'error');
        }
    }

    function clearFile() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        document.getElementById('paymentDateSection').style.display = 'none';
        analyzeBtn.disabled = true;
    }

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        console.log('Form submitted!');
        
        // Validate file selection
        if ((!fileInput.files || fileInput.files.length === 0) && !window.selectedFile) {
            e.preventDefault();
            showToast('Por favor, selecione um arquivo PDF', 'error');
            console.log('No file selected, preventing submission');
            return;
        }
        
        // If we have a selected file but no input file, create a FormData manually
        if (window.selectedFile && (!fileInput.files || fileInput.files.length === 0)) {
            e.preventDefault();
            console.log('Submitting with selected file:', window.selectedFile.name);
            
            const formData = new FormData();
            formData.append('file', window.selectedFile);
            
            const originalText = showLoading(analyzeBtn);
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.text();
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showToast('Erro ao fazer upload do arquivo', 'error');
                restoreButton(analyzeBtn, originalText);
            });
            
            return;
        }
        
        const originalText = showLoading(analyzeBtn);
        
        // Restore button after 10 seconds as fallback
        setTimeout(() => {
            restoreButton(analyzeBtn, originalText);
        }, 10000);
    });

    // Debug: Check if button is clickable
    analyzeBtn.addEventListener('click', function(e) {
        console.log('Button clicked! Disabled:', this.disabled);
        if (this.disabled) {
            e.preventDefault();
            console.log('Button is disabled, preventing submission');
        }
    });

    // Export to MongoDB
    function exportToMongoDB() {
        fetch('/api/export_mongodb')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Arquivo ${data.filename} criado com ${data.count} transações`, 'success');
                } else {
                    showToast(data.error || 'Erro ao exportar', 'error');
                }
            })
            .catch(error => {
                showToast('Erro ao exportar dados', 'error');
            });
    }
</script>
{% endblock %}